#include EditRKM8D.vih
#include iInterfSys_506.vih

#component "M_MNPLAN"

interface iInterfSys_506;

var
  gldt            : GlobData;
  iom             : oMainVid;
  //isg             : SetGetVid;
  //insTbl          : InsertTblMnpl;
  iSetPl          : SetupMnf;
  //iSetType        : TypeObjMnf;
  //GetN            : Util_GetName;
  //gKau            : OiWorkWithKAU;
  //ium             : Util_Common;
  ifc             : AGAT::EditRKM8D new;

create view
var
  _mnplanNrec: comp;
  _fptperNrec: comp;
as select *
from mnplan, fpperiod, wayaccou
where ((
  _mnplanNrec            == mnplan.nrec and
  mnplan.canval3         == fpperiod.nrec and
  mnplan.cwayaccou       == wayaccou.nrec
));


embedded scMain interface ifc;
end;

procedure initIfc;
{
  //message('initifc');

  if getfirst mnplan != tsok exit;

  var y1, y2, yb: word;
  y1 := year(mnplan.startdate);
  y2 := year(mnplan.enddate);
  if y1 = 0 y1 := year(cur_date);
  if y2 = 0 y2 := y1;
  if getfirst fpperiod = tsOk
    yb := year(fpperiod.dbeg)
  else
    yb := 0;

  ifc.initinterface(y1, y2, yb);
}

procedure OnPrint(reportKind: byte);
{
  if getfirst mnplan = tsOk
  {
    ifc.Save(mnplan.nrec, _fptperNrec);
    runinterface(AGAT::ReportRKMForm8D, mnplan.nrec, '', reportKind);
    initifc;
    ifc.Load(mnplan.nrec);
  }
}

//Реализация функций и методов Util_ScrSp---------------------------------------------------------------------
Function InitInter (pGldt: GLOBDATA; piOm: oMainVid): Boolean;
{
  //message('initinter');
  result := false;

  gldt       := pGldt;
  iom        := piOm;
  //isg        := iom.GetSetGetVid();
  //insTbl     := pgldt.GetInsertTblMnpl();
  iSetPl     := pgldt.GetSetupMnf();
  //iSetType   := pgldt.GetTypeObjMnf();
  //GetN       := pgldt.uGetName();
  //gKau       := pgldt.GetOiWorkWithKAU();
  //ium        := pgldt.GetMainInter();

  _fptperNrec := coGetTune('MAIN_PLANTIPPER');
  BindEvent(OnPrint, ifc.OnPrint);

  result := true;
}

Function DoneInter: Boolean;
{
  //message('doneinter');
  if (Not NullVipRef(gldt))
    FreeVipInterface(gldt);
  result := true;
}

Function SetOwner (ccMnPlan: Comp): Boolean;
{
  result := false;
  //message('setowner '+string(ccMnPlan,0,0));
  _mnplanNrec := ccMnPlan;

  if (getfirst mnplan != tsOk)
  {
    message(''#3'iInterfSys_506.SetOwner: Ошибка установки курсора на документ', Error);
    exit;
  }

  if (Not iSetPl.InitAll(MnPlan.cWayAccou))
  {
    Message(''#3'Ошибка инициализации шаблона', Error);
    Exit;
  }

  var docTitle: string; docTitle := 'Редактирование ПП: ';

  if getfirst wayaccou = tsOk
    docTitle += wayaccou.name;

  iom.GetMainScrPl.SetGetParam ( LongInt(102),
                                 word(1)    ,
                                 comp(0)    ,
                                 Double(0)  ,
                                 LongInt(0) ,
                                 word(0)    ,
                                 Date(0,0,0),
                                 _datetime(0,0,0,0,0,0,0),
                                 docTitle );

  initifc;
  ifc.load(_mnplanNrec);

  rereadrecord;
  result := true;
}

Procedure EventSetParVid (wFlag: Word);
{
  //message('eventsetparvid '+wFlag);
  if wFlag = 0 { };
}

Function SetWindowVid (sp: String): Boolean;
{
  //message('SetWindowVid '+sp);
  if (sp = '') { };
  result := true;
}

Function GetCurPos (var pWlist: Word): Comp;
{
  if (pWlist = 0) { }
  result := 0;
}

Procedure MySetColumnTitle;
{
}

Procedure FillHaveInReserv (Date2Q: Date);
{
  if (Date2Q <> Date2Q) { }
}

Function CheckEnableUseInterface (SysNumVid: Word; WayAccouNRec: Comp; NumVid_WayAccou: Comp; Flag: Word): Boolean;
{
  if ((SysNumVid = 0) and (WayAccouNRec = 0) and (NumVid_WayAccou = 0) and (Flag = 0)) { }
  result := true;
}

Function GetNameInter: String;
{
  result := 'iInterfSys_506';
}

Function GetNameInterPr: String;
{
  result := '';
}

Function GetNum: Word;
{
  result := 10506;
}

Function GetName: String;
{
  result := 'Агат. Интерфейс редактирования Формы 8Д РКМ';
}

Function GetMemo (st: oSteckCommonString): Boolean;
{
  st.push('Интерфейс редактирования Формы 8Д РКМ');
  st.push('Представление период');
  result := true;
}

procedure refreshifc;
{
  if getfirst mnplan = tsOk
  {
    StartNewVisual(vtRotateVisual,vfTimer,'Обновление',0);
    ifc.Save(mnplan.nrec, _fptperNrec);
    initifc;
    ifc.Load(mnplan.nrec);
    StopVisual('',0);
  }
}

Function SetGetParam (var FlagParam: LongInt; var Direction: Word; var cValue: Comp; var dValue: Double; var lValue: LongInt; var wValue: Word; var dtValue: Date; var dttValue: DateTime; var sValue: s250): Boolean;
{
  result := true;
  if ((cValue > 0) and (dValue > 0) and (lValue > 0) and (wValue > 0) and (sValue = '') and (dtValue = dttValue)) { }

  //message ('SetGetParam: FlagParam='+FlagParam+', Direction='+Direction+', cValue='+cValue+
  //         ''#13', dValue='+dValue+', lValue='+lValue+', wValue='+wValue+
  //         ''#13', dtValue='+dtvalue+', dttValue='+dttValue+', sValue='+sValue);

  if (( Direction and 1) > 0)
  {
    case FlagParam of
      1, 10000:
      {
        initifc;
        if getfirst mnplan = tsOk
          ifc.Load(mnplan.nrec);
      }
      2, 1000:
      {
        refreshifc
      }
      15:
      {
        StartNewVisual(vtRotateVisual,vfTimer,'Сохранение',0);
        if getfirst mnplan = tsOk
          ifc.save(mnplan.nrec, _fptperNrec);
        StopVisual('',0);
      }
    end;

  }
}

end.
