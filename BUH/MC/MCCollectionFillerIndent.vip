#include MCCollectionItem.vih
#include MCCollectionFiller.vih
#include system.vih

#component "AGAT"

interface MCCollectionFillerIndent; //заполнение заявки МЦ из коллекции

create view
as select *
from claim;

sql query qClaim =
select count(i.nrec) as CNT
from indent i
join claim c on c.cindent = i.nrec
where i.nrec = :indentNrec
group by i.nrec
;

procedure IMCCollectionFiller.FillDoc(aDocNrec: comp; aCollection: ICollection);
{
  var enum: IEnumerator;
  enum := aCollection.GetEnumerator;

  var rs: IResultSet;
  rs := queryManager.createquery(qClaim).setparam('indentNrec', aDocNrec).getresultset;
  var cnt: word;
  if rs != nullref
    cnt := rs.row.val('CNT');
  var i: word;
  if cnt = 0
    i := 1
  else
    i := cnt + 1;
  while enum.MoveNext
  {
    var mci: IMCCollectionItem;
    mci := enum.Current;
    ClearBuffer(#claim);
      claim.wpos    := i;
      claim.prmc    := 1;
      claim.cindent := aDocNrec;
      claim.CMCUSL  := mci.MC.Nrec;
      claim.CGROUP  := mci.MC.GroupmcNrec;
      claim.cotped  := mci.OtpEd;
      claim.kol     := mci.Qty;
    insert current claim;
    i++;
  }
}

end.
