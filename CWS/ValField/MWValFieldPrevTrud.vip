#component "AGAT"
interface iMWValFieldPrevTrud;

sql query SelectPrevTrud =
select sum(ValSpMnP.vPrice)
from SpMnPlan MainSpMnPlan
join Marsh_Sp MSPMain on MainSpMnPlan.cAnVal3 = MSPMain.nRec
join MnPlan on MnPlan.cWayAccou = ?
join FpPeriod on MnPlan.cAnVal1 = FpPeriod.nRec and FpPeriod < ?
join SpMnPlan SpMnPlan1 on MainSpMnPlan.TypeIzd = SpMnPlan1.TypeIzd and
                           MainSpMnPlan.cIzd = SpMnPlan1.cIzd and
                           MnPlan.nRec = SpMnPlan1.cMnPlan and
                           MainSpMnPlan.wKodGr1 = SpMnPlan1.wKodGr1 and
                           MainSpMnPlan.cAnVal1 = SpMnPlan1.cAnVal1
join Marsh_Sp MSP1 on SpMnPlan1.cAnVal3 = MSP1.nRec and MSPMain.nOpe = MSP1.nOpe
join SpMnPl on SpMnPlan1.nRec = SpMnPl.cSpMnPlan and
               22 = SpMnPl.wKolAn and
               21 = SpMnPl.wKodGr4 and
               FpPeriod.nRec = SpMnPl.cAnVal4 and
               SpMnPl.wKodGr5 = ? and
               SpMnPl.cAnVal5 = ?
join ValSpMnP on SpMnPl.nRec = ValSpMnP.cSpMnPl
where MainSpMnPlan.nrec = ?
;

function oMWValField.CheckValue(Row: oMWRow; _Value: double): boolean;
{
  Row := Row;
  _Value := _Value;
  result := false;
}
function  oMWValField.Editable(Row: oMWRow): boolean;
{
  Row := Row;
  result := false;
}
procedure oMWValField.LoadValue(Row:  oMWRow);
{
  if Row.isLeaf
  {
    var _d: double;
    var stmt: longint;
    var _cSpMnPlan, _cCostItem: comp;

    _cSpMnPlan := Row.cSpMnPlan;
    _cCostItem := fMWValFieldsManager.ValFieldFactTrud.cCostItem;

    stmt := sqlAllocStmt;
    sqlBindParam(stmt, 1, cMnPlanWayAccou);
    sqlBindParam(stmt, 2, PeriodDBeg);
    sqlBindParam(stmt, 3, CostItemKodGroup);
    sqlBindParam(stmt, 4, _cCostItem);
    sqlBindParam(stmt, 5, _cSpMnPlan);
    sqlBindCol(stmt, 1, _d);
    sqlPrepare(stmt, SelectPrevTrud);
    sqlExecute(stmt);
    if sqlFetch(stmt) = tsOk
      SetValue(Row, _d);
  }
}
function  oMWValField.GetFontBackColor(Row: oMWRow): integer;
{
  Row := Row;
  result := 67;
}
end.
