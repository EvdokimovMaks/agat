//******************************************************************************
//                                                      (c) корпорация Галактика
// Галактика 7.12 - Логистика
// Функции работы с ДЕИ
//******************************************************************************

#ifdef __DEIfunsV1__

//******************************************************************************

var oKatDEI: iKatDEI;

Create view vDEIfuns
;

#include ukrdeitmp.vpp

//******************************************************************************

Procedure UpdateDEIKolSpSopr(
                SpSopr__NRec     : comp;
                SPSopr__Vidsopr  : word;
                SpSopr__cMCUsl   : comp;
#ifdef Gal9_1
                SpSopr__PrMC     : word;
#else
                SpSopr__PrMC     : comp;
#end
                wTipKol          : word;   // wTipKol: 1 - Kolfact  2 - Kol   3 - KolOpl
                _OldKol          : double;
                _NewKol          : double;
                lParam           : longint
          );
{
  if NOT DopEd_Used2(SpSopr__VidSopr)
    Exit;

  oKatDEI.SetDefaultDopEd( word(coSpSopr)  // _wTable: word;     // код таблицы спецификации
                         , SpSopr__NRec    // _cRec: comp;       // ссылка на запись спецификации
                         , wTipKol         // _wTipKol: word;    // тип количества
                         , SpSopr__cMCUsl  // _cMCUsl: comp;     // ссылка на МЦ/Услугу
                         , SpSopr__PrMC    // _PrMC: word;       // признак МЦ/Услуга
                         , _OldKol         // старое количество
                         , _NewKol         // _Kol: double       // количество в отпускных единицах
                         , lParam
                         , SpSopr__VidSopr // тип документа системный
                         );
}

//******************************************************************************

Procedure CopyDEISpSteptoSpSopr(
                SpStep__NRec     : comp;
                SpSopr__NRec     : comp;
                SpSopr__VidSopr  : word;
                _wTipKolSrc      : word;    // тип количества источника
                _KolSrc          : double;  // количество источника в отпускных
                _wTipKolDest     : word;    // тип количества приемника
                _KolDest         : double   // количество приемника в отпускных
          );
{
  if NOT DopEd_Used2(SpSopr__VidSopr)
    Exit;

  if NOT DopEd_Auto2(SpSopr__VidSopr)
    Exit;

  oKatDEI.CopyDopEd( word(coSpStep)
                   , SpStep__NRec
                   , _wTipKolSrc
                   , _KolSrc
                   , word(coSpSopr)
                   , SpSopr__NRec
                   , _wTipKolDest
                   , _KolDest
                   , SpSopr__VidSopr
                   );
}

//******************************************************************************

Procedure CopyDEISpDocstoSpSopr(
                SpDocs__NRec     : comp;
                SpSopr__NRec     : comp;
                SpSopr__VidSopr  : word;
                _wTipKolSrc      : word;    // тип количества источника
                _KolSrc          : double;  // количество источника в отпускных
                _wTipKolDest     : word;    // тип количества приемника
                _KolDest         : double   // количество приемника в отпускных
          );
{
  if NOT DopEd_Used2(SpSopr__VidSopr)
    Exit;

  if NOT DopEd_Auto2(SpSopr__VidSopr)
    Exit;

  oKatDEI.CopyDopEd( word(coSpDocs)
                   , SpDocs__NRec
                   , _wTipKolSrc
                   , _KolSrc
                   , word(coSpSopr)
                   , SpSopr__NRec
                   , _wTipKolDest
                   , _KolDest
                   , SpSopr__VidSopr
                   );
}

//******************************************************************************

Function GetTiDk(w: word): word;
{
  case w of
    101: GetTiDK := 41;
    102: GetTiDK := 42;
    111: GetTiDK := 43;
    201: GetTiDK := 51;
    202: GetTiDK := 52;
    211: GetTiDK := 53;
    501: GetTiDK := 61;
    else GetTiDK := 0;
  end;
}

//******************************************************************************

Procedure UpdateDEIKolSpStep(
                SpStep_NRec    : comp;
                SpStep_PrMC    : word;
                SpStep_cMCUsl  : comp;
                wTipKol        : word;      // wTipKol: 1 - KolSkl 2 - Kol 3 - KolOpl
                _OldKol        : double;
                _NewKol        : double;
                lParam         : longint;
                _wVidDoc       : word
          );
{
  if ( SpStep_PrMC <> 1 )
    Exit;

  var _wTiDk: word;  _wTiDk := GetTiDk(_wVidDoc);
  if (_wTiDk = 0)
    Exit;

  if NOT DopEd_Used2(_wTiDk)
    Exit;

  oKatDEI.SetDefaultDopEd( coSpStep           // код таблицы спецификации
                         , SpStep_NRec        // ссылка на запись спецификации
                         , wTipKol            // тип количества
                         , SpStep_cMCUsl      // ссылка на МЦ/Услугу
                         , SpStep_PrMC        // признак МЦ/Услуга
                         , _OldKol            // старое количество
                         , _NewKol            // количество в отпускных единицах
                         , lParam
                         , _wTiDk             // тип документа системный
                         );
}

//******************************************************************************
//
Procedure CopyDEISpDocstoSpStep(
                 SpDocs_NRec  : comp;
                 SpStep_NRec  : comp;
                _wTipKolSrc   : word;    // тип количества источника
                _KolSrc       : double;  // количество источника в отпускных
                _wTipKolDest  : word;    // тип количества приемника
                _KolDest      : double;  // количество приемника в отпускных
                _wVidDoc      : word     // вид ДО
           );
{
  var _wTiDk: word;  _wTiDk := GetTiDk(_wVidDoc);
  if (_wTiDk = 0)
    Exit;

  if NOT DopEd_Used2(_wTiDk)
    Exit;

  if NOT DopEd_Auto2(_wTiDk)
    Exit;

  oKatDEI.CopyDopEd( word(coSpDocs)
                   , SpDocs_NRec
                   , _wTipKolSrc
                   , _KolSrc
                   , word(coSpStep)
                   , SpStep_NRec
                   , _wTipKolDest
                   , _KolDest
                   , _wTiDK
                   );
}

//******************************************************************************
//
Procedure CopyDEISpStep2(
                _cRecSrc      : comp;    // NRec источника
                _wTipKolSrc   : word;    // тип количества источника
                _KolSrc       : double;  // количество источника в отпускных
                _cRecDest     : comp;    // NRec приемника
                _wTipKolDest  : word;    // тип количества приемника
                _KolDest      : double;  // количество приемника в отпускных
                _wVidDoc      : word     // вид ДО
          );
{
  var _wTiDk: word;  _wTiDk := GetTiDk(_wVidDoc);
  if (_wTiDk = 0)
    Exit;

  if NOT DopEd_Used2(_wTiDk)
    Exit;

  if NOT DopEd_Auto2(_wTiDk)
    Exit;

  oKatDEI.CopyDopEd( word(coSpStep)
                   , _cRecSrc
                   , _wTipKolSrc
                   , _KolSrc
                   , word(coSpStep)
                   , _cRecDest
                   , _wTipKolDest
                   , _KolDest
                   , _wTiDK
                   );
}

//******************************************************************************
//
Procedure CopyDEISpSoprtoSpStep(
                _cRecSrc      : comp;    // NRec источника
                _wTipKolSrc   : word;    // тип количества источника
                _KolSrc       : double;  // количество источника в отпускных
                _cRecDest     : comp;    // NRec приемника
                _wTipKolDest  : word;    // тип количества приемника
                _KolDest      : double;  // количество приемника в отпускных
                _wVidDoc      : word     // вид ДО
          );
{
  var _wTiDk: word;  _wTiDk := GetTiDk(_wVidDoc);
  if (_wTiDk = 0)
    Exit;

  if NOT DopEd_Used2(_wTiDk)
    Exit;

  if NOT DopEd_Auto2(_wTiDk)
    Exit;

  oKatDEI.CopyDopEd( word(coSpSopr)
                   , _cRecSrc
                   , _wTipKolSrc
                   , _KolSrc
                   , word(coSpStep)
                   , _cRecDest
                   , _wTipKolDest
                   , _KolDest
                   , _wTiDK
                   );
}
//******************************************************************************

#end
