//------------------------------------------------------------------------------
//                                                      (c) корпорация Галактика
// Галактика 8.10 - модуль "Управление бюджетом"
// Библиотека функций : "Значения показателей бюджетирования"
//------------------------------------------------------------------------------

#ifndef __FpL2Val_Vih__
#define __FpL2Val_Vih__

#ifdef  ComponentVersion
#component "F_FpBudget"
#endif//ComponentVersion

//------------------------------------------------------------------------------
#include FpTypes.Inc     // Все типы данных FP (а надо только TFpBudEditCellInfo)
#include FpCellsInfo.Tbl // таблица коэфициентов распределения агрегата по аналитике
//------------------------------------------------------------------------------

//==============================================================================
#doc
Библиотека функций : "Значения показателей бюджетирования"<br>
<b>Внимание!</b> Интерфейс предназначен только для внутреннего использования<br>
#end
Private ObjInterface iLibRaspAgrFpValues;  //#region ObjInterface

  //============================================================================
  //#region ERROR
  //----------------------------------------------------------------------------
  #doc
     Функция возвращает описание последней ошибки
  #end
  Function GetStLastError : string;
  //----------------------------------------------------------------------------
  #doc
     Вывод сообщения последней ошибки
  #end
  Function RunShowError : boolean;
  //#endregion ERROR
  //****************************************************************************


  //============================================================================
  //#region MODIFY
  //----------------------------------------------------------------------------
  #doc
     Установить листовое значение показателя
  #end
  Function SetLeafValue(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _OldSum     : double;              // прежняя сумма        
      _NewSum     : double               // новая сумма          
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Распределить агрегат в режиме:
     'А - на "прочие", П - равномерно'               
  #end
  Function RaspAnToOther(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _OldSum     : double;              // прежняя сумма
      _NewSum     : double               // новая сумма
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Распределить агрегат в режиме:
     'А, П - Новое/Старое'                           
  #end
  Function RaspAnByOld(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _OldSum     : double;              // прежняя сумма        
      _NewSum     : double               // новая сумма          
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Распределить агрегат иерархии
  #end
  Function RaspHierAgr(
    _wHSBMode     : word;                // режим распределения по иерархии статьи
    _wHAnMode     : word;                // режим распределения по иерархии аналитик
    _wHPVMode     : word;                // режим предварительного просмотра распределения по иерархии
    _wAlgMode     : word;                // режим распределения по аналитическим уровням
    _rcCellInfo   : TFpBudEditCellInfo;  // информация о агрегате
    _OldSum       : double;              // прежняя сумма        
    _NewSum       : double               // новая сумма          
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Удалить данные показателя
  #end
  Function DelValue(
    _rcCellInfo   : TFpBudEditCellInfo   // информация о агрегате
  ) : boolean;

  //#endregion MODIFY
  //****************************************************************************


  //============================================================================
  //#region BaseAgr
  //----------------------------------------------------------------------------
  #doc
     Отменить выбор "базового" агрегата
  #end
  Procedure UnCheckBaseAgr;

  //----------------------------------------------------------------------------
  #doc
     Установить значение "базового" агрегата
  #end
  Function SetBaseByKodAndMean(
      _AgrKodGrKau : word;               // код аналитики
      _cAgrMean    : comp                // значение аналитики
  ): boolean;                           

  //----------------------------------------------------------------------------
  #doc
     Получить код и значение аналитики "базового" агрегата
  #end
  Function GetBaseAgrKodAndMean(
  var _AgrKodGrKau: word;                // код аналитики
  var _cAgrMean   : comp                 // значение аналитики
  ): boolean;                            // true - если агрегат выбран

  //----------------------------------------------------------------------------
  #doc
     Получить NREC значения "базового" агрегата
  #end
  Function GetBaseAgrNRec: comp;

  //----------------------------------------------------------------------------
  #doc
     Получить наименование значения "базового" агрегата
  #end
  Function GetBaseAgrName: string;
  //#endregion BaseAgr
  //****************************************************************************


  //============================================================================
  //#region CoeffTable
  //----------------------------------------------------------------------------
  #doc
     Добавить новую запись в список коэффициентов распределения
  #end
  Function AddAnaliticsToFpCellsInfoTable(
      _KodGrKau   : word;                // код аналитики
      _cMean      : comp;                // значение аналитики
      _rcCellInfo : TFpBudEditCellInfo   // информация о агрегате
  ) : comp;

  //----------------------------------------------------------------------------
  #doc
     Удалить запись коэффициентов распределения
  #end
  Function DeleteFpCellsInfoTable(
      _NRec : comp
  ): word;

  //----------------------------------------------------------------------------
  #doc
     Очистить таблицу коэффициентов распределения
  #end
  Function FreeFpCellsInfoTable: word;

  //----------------------------------------------------------------------------
  #doc
    Проверить есть ли данные в таблице коэффициентов распределения
    NotCheckOthers - не проверять прочие
  #end
  Function CheckCellsInfoTableHasData(
      _isCheckOthers : boolean           // проверять "прочие"
  ): boolean;

  //----------------------------------------------------------------------------
  #doc
     Очистить таблицу информации о "других" агрегатах
  #end
  Function ClearAgrCellsInfoList: word;

  //----------------------------------------------------------------------------
  #doc
     Добавить новый агрегат в список "других" агрегатов
  #end
  Function AddAgrCellsInfoList(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _Name       : string;              // наименование агрегата
      _KodGrKau   : word;                // код аналитики 
      _cMean      : comp                 // значение аналитики
  ) : word;

  //----------------------------------------------------------------------------
  #doc
     Проверить выбранный "другой" агрегат. 
     Если требуется, то открыть окно выбора агрегата 
  #end
  Function CheckAndChangeAgr(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // код аналитики 
      _OpenWindow : boolean              // отклывать ли окон
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Сохранить результат распределения в FpValues. Для пользовательского распределения прочих.
     При записи первоначально пытается распределить по аналитике и периодам как
     Новое / Старое, если старых значений нет, то на прочие.
  #end
  Function SaveCurrentCoefficientsOfOthers(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // код аналитики
      _OthersSum  : double;              // значение прочих
      _OldSum     : double               // значение агрегата
  ): boolean;

  //----------------------------------------------------------------------------
  #doc
     Сохранить результат распределения в FpValues.
     При записи первоначально пытается распределить по аналитике и периодам как
     Новое / Старое, если старых значений нет, то на прочие.
  #end
  Function SaveCurrentCoefficients(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // код аналитики
      _NewSum     : double               // новое значение агрегата
  ): boolean;
  //#endregion CoeffTable
  //****************************************************************************


  //============================================================================
  //#region FillCoeffTable
  //----------------------------------------------------------------------------
  #doc
     Заполнение таблицы коэффициентов для режима:
     'А - согласно весам другого агрегата'
  #end
  Function FillCoeffTable_AgrByBaseCoeff(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // прежняя сумма        
      _NewSum     : double;              // новая сумма          
      _cNode      : comp                 // выстоящий
  ): boolean;

  //----------------------------------------------------------------------------
  #doc
     Заполнение таблицы коэффициентов для режима:
     'А - согласно заданным весам'
  #end
  Function FillCoeffTable_AgrByUserCoeff(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // прежняя сумма        
      _NewSum     : double               // новая сумма          
  ) : boolean;

  //----------------------------------------------------------------------------
  #doc
     Заполнение таблицы коэффициентов для режимов:
     'А - "прочие" согласно текущему уровню аналитик'
     'А - "прочие" согласно заданным весам'          
  #end
  Function FillCoeffTable_OtherByCoeff(
      _rcCellInfo : TFpBudEditCellInfo;  // информация о агрегате
      _KodGrKau   : word;                // прежняя сумма
      _OldSum     : double;              // новая сумма
      _isByNewOld : boolean;             // режим новое/старое
  var _OthersSum  : double               // сумма прочих
  ): boolean;
  //#endregion FillCoeffTable
  //****************************************************************************

End; //#endregion ObjInterface
//******************************************************************************


//==============================================================================
VipInterface LibRaspAgrFpValues implements iLibRaspAgrFpValues
#Licensed_Free;
Public:
  Constructor Init;
  Destructor  Done;
End;
//******************************************************************************


#endif//__FpL2Val_Vih__

